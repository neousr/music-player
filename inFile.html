<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Type File</title>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
        }

        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>

    <main>

        <div style="border: 3px solid crimson;border-radius: 4px;background-color: aliceblue;padding: .5rem;">

            <div>
                <label for="input-file">Choose audio files</label>
                <!-- A valid MIME type string, with no extensions.
                The string audio/* meaning "any audio file".
                The string video/* meaning "any video file".
                The string image/* meaning "any image file". -->
                <!-- accept="image/png, image/jpeg" -->
                <input type="file" id="input-file" accept="audio/*" multiple>
            </div>

        </div>

    </main>

    <!-- <script src="utils.js"></script> -->

    <script>

        "use strict";

        const inputFile = document.getElementById("input-file");
        const downloadLink = document.createElement("a");

        let fileListLen;
        const filename = "playlist.json";

        const audio = new Audio();
        audio.preload = "metadata";

        const validFileType = file => {
            return true;
        }

        const rmWhiteSpaces = text => {
            return text.replace(/\s\s+/g, " ").trim();
        }

        const getArtist = name => {
            return name.slice(0, name.indexOf(" - "));
        }

        const getTitle = name => {
            return name.slice(name.indexOf(" - ") + 3, - 4);
        }

        const getTrackInfo = name => {
            name = rmWhiteSpaces(name);
            return {
                artist: getArtist(name),
                title: getTitle(name)
            }
        }

        const waitForMetadata = audio => {

            return new Promise((resolve, reject) => {

                const onLoaded = () => resolve(audio.duration);

                const onError = () => reject(new Error("Error cargando metadata"));

                audio.addEventListener("loadedmetadata", onLoaded, { once: true });

                audio.addEventListener("error", onError, { once: true });

            });
        }

        const loadDurations = async fileList => {

            const tracks = new Array(fileListLen);

            for (let i = 0; i < fileListLen; i++) {

                audio.pause(); // por seguridad
                const blobURL = URL.createObjectURL(fileList[i]);

                audio.src = blobURL; // cambiar fuente
                audio.load(); // forzar carga

                const trackInfo = getTrackInfo(fileList[i].name);

                const track = {
                    track_id: i + 1,
                    name: fileList[i].name,
                    artist: trackInfo.artist,
                    title: trackInfo.title,
                    duration: 0,
                    size: fileList[i].size,
                    type: fileList[i].type
                };

                try {
                    track.duration = await waitForMetadata(audio);
                } catch (error) {
                    console.error("❌", fileList[i], error.message);
                }

                tracks[i] = track;
            }

            return tracks;
        }

        const init = () => {

            inputFile.addEventListener("change", async e => {

                if (inputFile.files.length < 1) return;

                const fileList = inputFile.files;

                fileListLen = fileList.length;

                const playlist = {
                    id: 1,
                    name: "salsa",
                    description: "Lo mejor de la salsa romántica",
                    tracks: {
                        total: fileListLen,
                        items: await loadDurations(fileList)
                    }
                }

                const blob = new Blob([JSON.stringify(playlist, null, 2)], { type: "application/json" });

                const url = URL.createObjectURL(blob);

                downloadLink.href = url;

                downloadLink.download = filename;

                // d.body.appendChild(downloadLink);

                downloadLink.click();

                // d.body.removeChild(downloadLink);

                URL.revokeObjectURL(url);

            });
        }

        document.addEventListener("DOMContentLoaded", e => {

            init();

        });

        // References
        // https://github.com/lerocha/chinook-database

    </script>

</body>

</html>